import { decodeJwt } from "jose";
import type { UserV2 } from "types/auth";
import type { SessionData, Stored } from "./session";

export class Util {
  protected toUser(data: SessionData): UserV2 {
    const {
      endows = "",
      funds = "",
      "cognito:groups": groups = [],
      ...p
    }: any = decodeJwt(data.token_id);

    return {
      idToken: data.token_id,
      accessToken: data.token_access,
      refreshToken: data.token_refresh,
      groups,
      endowments: endows.split(",").map(Number) ?? [],
      funds: funds.split(",") ?? [],
      email: p.email,
      firstName: p.given_name,
      lastName: p.family_name,
      avatar: p["custom:avatar"],
      currency: p["custom:currency"],
      referral_id: p["custom:referral_id"],
      pay_id: p["custom:pay_id"],
      pay_min: p["custom:pay_min"],
      stripe_customer_id: p["custom:stripe_customer_id"],
    };
  }
  protected unset(session: Stored) {
    session.unset("token_id");
    session.unset("token_access");
    session.unset("token_refresh");
    session.unset("token_expiry");
  }
}
